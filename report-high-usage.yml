- hosts: localhost
  gather_facts: false

  vars:
    project_id: "joey-preprod-project"
    zone: "asia-southeast2-a"
    region: "asia-southeast2"
    teams_webhook_url: "https://default4d237fc5b1dd42efa9e264887cb44b.21.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/4853a33866174df5a29410585f0e9cf5/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8E44F_-FX_eJN1eLrAYmL-klR-9puxICRAv2IkzV7cA"

  tasks:

  ###############################################################
  # AUTH
  ###############################################################

  - name: Write GCP SA
    copy:
      content: "{{ gcp_sa_key }}"
      dest: /tmp/gcp-sa.json
      mode: '0600'

  - name: Authenticate
    command: gcloud auth activate-service-account --key-file=/tmp/gcp-sa.json
    changed_when: false

  ###############################################################
  # VM MACHINE TYPE RECOMMENDER (HIGH USAGE = SCALE UP)
  ###############################################################

  - name: Get VM recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ zone }}
      --recommender google.compute.instance.MachineTypeRecommender
      --format=json
    register: vm_raw
    changed_when: false
    failed_when: false

  - name: Parse VM recommendations
    set_fact:
      vm_recs: "{{ vm_raw.stdout | default('[]') | from_json }}"

  - name: Init VM high usage list
    set_fact:
      vm_high: []

  - name: Get current VM machine types
    command: >
      gcloud compute instances describe
      {{ item.content.operationGroups[0].operations[0].resource.split('/')[-1] }}
      --zone {{ zone }}
      --project {{ project_id }}
      --format="value(machineType)"
    register: current_vm
    loop: "{{ vm_recs }}"
    changed_when: false
    failed_when: false

  - name: Append VM scale-up only
    set_fact:
      vm_high: "{{ vm_high + [ {
        'instance': item.item.content.operationGroups[0].operations[0].resource.split('/')[-1],
        'current': item.stdout.split('/')[-1],
        'suggested': item.item.content.operationGroups[0].operations[0].value.machineType.split('/')[-1],
        'priority': item.item.priority | default('N/A'),
        'severity': (
          'ğŸ”¥ Critical' if item.item.priority == 'P1'
          else 'âš  High' if item.item.priority == 'P2'
          else 'â„¹ Medium' if item.item.priority == 'P3'
          else 'ğŸŸ¢ Low' if item.item.priority == 'P4'
          else 'â„¹ Info'
        ),
        'priority': item.item.priority | default('N/A'),
        'console_link': 'https://console.cloud.google.com/compute/instancesDetail/zones/' ~
                        zone ~
                        '/instances/' ~
                        item.item.content.operationGroups[0].operations[0].resource.split('/')[-1] ~
                        '?project=' ~ project_id
      } ] }}"
    loop: "{{ current_vm.results }}"
    when: >
      item.stdout is defined and
      (
        item.stdout.split('/')[-1].split('-')[-1] | int
      )
      <
      (
        item.item.content.operationGroups[0].operations[0].value.machineType.split('/')[-1].split('-')[-1] | int
      )


  ###############################################################
  # CLOUD SQL PERFORMANCE RECOMMENDER
  ###############################################################

  - name: Get SQL recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ region }}
      --recommender google.cloudsql.instance.PerformanceRecommender
      --format=json
    register: sql_raw
    changed_when: false
    failed_when: false

  - name: Parse SQL recommendations
    set_fact:
      sql_recs: "{{ sql_raw.stdout | default('[]') | from_json }}"

  - name: Init SQL high usage list
    set_fact:
      sql_high: []

  - name: Append SQL high usage
    set_fact:
      sql_high: "{{ sql_high + [ {
        'instance': rec.content.overview.instanceName,
        'engine': rec.content.overview.databaseEngine,
        'priority': rec.priority | default('N/A'),
        'severity': (
          'ğŸ”¥ Critical' if rec.priority == 'P1'
          else 'âš  High' if rec.priority == 'P2'
          else 'â„¹ Medium' if rec.priority == 'P3'
          else 'ğŸŸ¢ Low' if rec.priority == 'P4'
          else 'â„¹ Info'
        ),
        'impact': rec.primaryImpact.category | default('PERFORMANCE'),
        'short_issue': (rec.description.split('.')[0] ~ '.') if rec.description is defined else 'Performance issue detected.',
        'console_link': 'https://console.cloud.google.com/sql/instances/' ~
                        rec.content.overview.instanceName ~
                        '/overview?project=' ~ project_id
      } ] }}"
    loop: "{{ sql_recs }}"
    loop_control:
      loop_var: rec
    when:
      - rec.primaryImpact is defined
      - rec.primaryImpact.category == "PERFORMANCE"
      - rec.stateInfo.state == "ACTIVE"




  ###############################################################
  # BUILD MESSAGE
  ###############################################################

  - name: Set execution timestamp
    set_fact:
      exec_time: "{{ lookup('pipe', 'TZ=Asia/Jakarta date +\"%d-%m-%Y %H:%M:%S WIB\"') }}"
    
  - name: Build Teams message
    set_fact:
      teams_message: |
        ğŸš¨ <b>GCP HIGH USAGE ALERT</b><br>
        <b>Project:</b> {{ project_id }}<br><br>
  
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>
  
        <b>ğŸ–¥ VM SCALE-UP REQUIRED</b><br>
        {% if vm_high | length == 0 %}
        âœ… No VM experiencing high usage.<br><br>
        {% else %}
        {% for v in vm_high %}
        ğŸ”¹ <b>{{ v.instance }}</b><br>
        â€¢ Severity: {{ v.severity }} ({{ v.priority }})<br>
        â€¢ Current Type: {{ v.current }}<br>
        â€¢ Suggested Type: {{ v.suggested }}<br>
        â€¢ Impact: PERFORMANCE<br>
        â€¢ Console: <a href="{{ v.console_link }}">Open VM</a><br><br>
        {% endfor %}
        {% endif %}
  
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>
  
        <b>ğŸ—„ CLOUD SQL PERFORMANCE</b><br>
        {% if sql_high | length == 0 %}
        âœ… No SQL high usage detected.<br><br>
        {% else %}
        {% for s in sql_high %}
        ğŸ”¹ <b>{{ s.instance }}</b><br>
        â€¢ Severity: {{ s.severity }} ({{ s.priority }})<br>
        â€¢ Engine: {{ s.engine }}<br>
        â€¢ Impact: {{ s.impact }}<br>
        â€¢ Issue: {{ s.short_issue }}<br>
        â€¢ Console: <a href="{{ s.console_link }}">Open SQL</a><br><br>
        {% endfor %}
        {% endif %}
  
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br>
        ğŸ“Š <b>Summary</b><br>
        â€¢ VM High Usage: {{ vm_high | length }}<br>
        â€¢ SQL High Usage: {{ sql_high | length }}<br><br>
  
        â„¹ <i>Investigate resources marked ğŸ”¥ or âš  immediately.</i>

  
        <b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b><br>
  
        <b>ğŸ—„ CLOUD SQL PERFORMANCE</b><br>
        {% if sql_high | length == 0 %}
        âœ… No SQL performance risk detected.<br><br>
        {% else %}
        {% for s in sql_high %}
        âš  <b>{{ s.instance }}</b><br>
        â€¢ Priority: <b>{{ s.priority }}</b><br>
        â€¢ Engine: {{ s.engine }}<br>
        â€¢ Issue: {{ s.short_issue }}<br>
        â€¢ Recommendation: Review memory configuration.<br>
        {% if s.link is defined %}
        â€¢ Console: <a href="{{ s.link }}">Open in GCP</a><br>
        {% endif %}
        <br>
        {% endfor %}
        {% endif %}
  
        <b>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</b><br>
        ğŸ“Š <b>Summary</b><br>
        â€¢ VM High Usage: {{ vm_high | length }}<br>
        â€¢ SQL High Usage: {{ sql_high | length }}<br><br>
  
        â„¹ <i>Review resources marked with ğŸ”¥ or âš  for immediate investigation.</i>



  ###############################################################
  # SEND TO TEAMS (Power Automate)
  ###############################################################

  - name: Send to Teams
    uri:
      url: "{{ teams_webhook_url }}"
      method: POST
      body_format: json
      body:
        text: "{{ teams_message }}"
      status_code: 202
