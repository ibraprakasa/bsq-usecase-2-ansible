- name: Send message to Microsoft Teams via Power Automate
  hosts: localhost
  gather_facts: false

  vars:
    # =========================
    # HARDCODED POWER AUTOMATE URL
    # =========================
    teams_webhook_url: "https://default4d237fc5b1dd42efa9e264887cb44b.21.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/94a679db1cd3403e82e75a8e1f0de0c7/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=A0nYXR8b0pMuPINueyCynuAFw_VhCBR8sCticsENRlU"

    # =========================
    # MESSAGE CONTENT
    # =========================
    teams_message: >
      ğŸ” GCP Recommender Report
      Project : joey-preprod-project
      Status  : OK
      Time    : {{ lookup('pipe', 'date "+%Y-%m-%d %H:%M:%S"') }}

  tasks:

    - name: Send message to Teams
      uri:
        url: "{{ teams_webhook_url }}"
        method: POST
        headers:
          Content-Type: application/json
        body_format: json
        body:
          text: "{{ teams_message | trim }}"
        status_code:
          - 200
          - 202
      register: teams_result

    - name: Show Teams response
      debug:
        msg:
          - "Teams message sent"
          - "HTTP status: {{ teams_result.status }}"
