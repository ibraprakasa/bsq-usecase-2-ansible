- hosts: localhost
  gather_facts: false

  vars:
    project_id: "joey-preprod-project"
    zone: "asia-southeast2-a"
    region: "asia-southeast2"

    dry_run: true   # ðŸ”¥ default SAFE mode

  tasks:

  ###############################################################
  # 0ï¸âƒ£ CREATE TEMP SERVICE ACCOUNT FILE
  ###############################################################

  - name: Write GCP Service Account JSON
    copy:
      content: "{{ gcp_sa_key }}"
      dest: /tmp/gcp-sa.json
      mode: '0600'

  - name: Authenticate to GCP
    command: gcloud auth activate-service-account --key-file=/tmp/gcp-sa.json
    changed_when: false


  ###############################################################
  # 1ï¸âƒ£ COMPUTE ENGINE â€” DOWNSIZE ONLY
  ###############################################################

  - name: Get MachineType recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ zone }}
      --recommender google.compute.instance.MachineTypeRecommender
      --format=json
    register: vm_recs_raw
    changed_when: false
    failed_when: false

  - name: Parse VM recommendations
    set_fact:
      vm_recs: "{{ vm_recs_raw.stdout | from_json }}"
    when: vm_recs_raw.stdout != ""

  - name: Process VM downsize recommendations
    when: vm_recs is defined and vm_recs | length > 0
    loop: "{{ vm_recs }}"
    loop_control:
      loop_var: rec
    block:

      - name: Extract instance name
        set_fact:
          instance_name: "{{ rec.content.operationGroups[0].operations[0].resource.split('/')[-1] }}"

      - name: Extract target machine type
        set_fact:
          target_machine_type: "{{ rec.content.operationGroups[0].operations[0].value.machineType.split('/')[-1] }}"

      - name: Get current machine type
        command: >
          gcloud compute instances describe {{ instance_name }}
          --zone {{ zone }}
          --project {{ project_id }}
          --format="value(machineType)"
        register: current_type_raw
        changed_when: false

      - name: Extract current machine type
        set_fact:
          current_machine_type: "{{ current_type_raw.stdout.split('/')[-1] }}"

      - name: Extract CPU size
        set_fact:
          current_cpu: "{{ current_machine_type.split('-')[-1] | int }}"
          target_cpu: "{{ target_machine_type.split('-')[-1] | int }}"

      - name: Show downsize plan
        when: target_cpu < current_cpu
        debug:
          msg: >
            DOWNSIZE VM {{ instance_name }}
            ({{ current_machine_type }} â†’ {{ target_machine_type }})

      - name: Stop instance
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud compute instances stop {{ instance_name }}
          --zone {{ zone }}
          --project {{ project_id }}

      - name: Resize instance
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud compute instances set-machine-type {{ instance_name }}
          --machine-type {{ target_machine_type }}
          --zone {{ zone }}
          --project {{ project_id }}

      - name: Start instance
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud compute instances start {{ instance_name }}
          --zone {{ zone }}
          --project {{ project_id }}

      - name: Mark recommendation succeeded
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud recommender recommendations mark-succeeded {{ rec.name }}
          --project {{ project_id }}
          --location {{ zone }}


  ###############################################################
  # 2ï¸âƒ£ CLOUD SQL â€” DOWNSIZE ONLY
  ###############################################################

  - name: Get Cloud SQL recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ region }}
      --recommender google.cloudsql.instance.PerformanceRecommender
      --format=json
    register: sql_recs_raw
    changed_when: false
    failed_when: false

  - name: Parse SQL recommendations
    set_fact:
      sql_recs: "{{ sql_recs_raw.stdout | from_json }}"
    when: sql_recs_raw.stdout != ""

  - name: Process SQL downsize recommendations
    when: sql_recs is defined and sql_recs | length > 0
    loop: "{{ sql_recs }}"
    loop_control:
      loop_var: rec
    block:

      - name: Extract SQL instance name
        set_fact:
          sql_instance: "{{ rec.content.operationGroups[0].operations[0].resource.split('/')[-1] }}"

      - name: Extract target tier
        set_fact:
          target_tier: "{{ rec.content.operationGroups[0].operations[0].value.settings.tier }}"

      - name: Get current SQL tier
        command: >
          gcloud sql instances describe {{ sql_instance }}
          --project {{ project_id }}
          --format="value(settings.tier)"
        register: current_sql_raw
        changed_when: false

      - name: Extract CPU comparison (simple compare)
        set_fact:
          current_cpu: "{{ current_sql_raw.stdout.split('-')[2] | int }}"
          target_cpu: "{{ target_tier.split('-')[2] | int }}"

      - name: Show SQL downsize plan
        when: target_cpu < current_cpu
        debug:
          msg: >
            DOWNSIZE SQL {{ sql_instance }}
            ({{ current_sql_raw.stdout }} â†’ {{ target_tier }})

      - name: Patch SQL instance
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud sql instances patch {{ sql_instance }}
          --tier={{ target_tier }}
          --project {{ project_id }}
          --quiet

      - name: Mark SQL recommendation succeeded
        when:
          - not dry_run
          - target_cpu < current_cpu
        command: >
          gcloud recommender recommendations mark-succeeded {{ rec.name }}
          --project {{ project_id }}
          --location {{ region }}
