---
- name: Use Case 2 - Right-Sizer Watchdog (GCP)
  hosts: localhost
  gather_facts: false

  vars:
    project_id: joey-preprod-project
    location: global
    report_file: /tmp/gcp_rightsizer_report.json

  tasks:

  # =====================
  # Recommender API
  # =====================

  - name: VM rightsizing recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ location }}
      --recommender google.compute.instance.MachineTypeRecommender
      --format=json
    register: vm_rightsizing
    failed_when: false
    changed_when: false

  - name: Idle image recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ location }}
      --recommender google.compute.image.IdleResourceRecommender
      --format=json
    register: idle_image
    failed_when: false
    changed_when: false

  - name: Idle compute disk recommendations
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ location }}
      --recommender google.compute.disk.IdleResourceRecommender
      --format=json
    register: idle_disk
    failed_when: false
    changed_when: false

  # =====================
  # GKE PVC (Metrics-based)
  # =====================

  - name: List GKE clusters
    command: >
      gcloud container clusters list
      --project {{ project_id }}
      --format=json
    register: gke_clusters
    failed_when: false
    changed_when: false

  - name: Collect PVC list (per cluster)
    command: >
      kubectl get pvc -A -o json
    register: pvc_list
    failed_when: false
    changed_when: false

  # =====================
  # Final report
  # =====================

  - name: Build consolidated report
    copy:
      dest: "{{ report_file }}"
      content: |
        {{
          {
            "project": project_id,
            "generated_at": lookup('pipe','date -Is'),
            "recommender_api": {
              "vm_rightsizing": (vm_rightsizing.stdout | default('[]') | from_json),
              "idle_image": (idle_image.stdout | default('[]') | from_json),
              "idle_compute_disk": (idle_disk.stdout | default('[]') | from_json)
            },
            "gke_analysis": {
              "clusters": (gke_clusters.stdout | default('[]') | from_json),
              "pvc_inventory": (pvc_list.stdout | default('{}') | from_json)
            },
            "notes": [
              "PVC idle detection requires Cloud Monitoring IO metrics",
              "GKE PVC cost recommendations are not fully exposed via Recommender API"
            ]
          } | to_nice_json
        }}

  - name: Export as AAP Job Artifact
    set_stats:
      data:
        gcp_rightsizer_report: "{{ lookup('file', report_file) }}"
