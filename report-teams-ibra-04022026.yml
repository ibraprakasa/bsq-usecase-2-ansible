- hosts: localhost
  gather_facts: false

  vars:
    project_id: "joey-preprod-project"

    recommenders:
      - google.compute.image.IdleResourceRecommender
      - google.compute.disk.IdleResourceRecommender
      - google.compute.instance.MachineTypeRecommender
      - google.compute.instanceAvailability.Recommender
      - google.compute.firewall.SecurityRecommender
      - google.iam.policy.Recommender
      - google.container.security.Recommender

    recommender_category_map:
      google.compute.image.IdleResourceRecommender: COST
      google.compute.disk.IdleResourceRecommender: COST
      google.compute.instance.MachineTypeRecommender: PERFORMANCE
      google.compute.instanceAvailability.Recommender: RELIABILITY
      google.compute.firewall.SecurityRecommender: SECURITY
      google.iam.policy.Recommender: SECURITY
      google.container.security.Recommender: SECURITY

    teams_webhook_url: "https://default4d237fc5b1dd42efa9e264887cb44b.21.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/94a679db1cd3403e82e75a8e1f0de0c7/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=A0nYXR8b0pMuPINueyCynuAFw_VhCBR8sCticsENRlU"

  tasks:

  - name: Write SA key
    copy:
      content: "{{ gcp_sa_key }}"
      dest: /tmp/gcp-sa.json
      mode: '0600'

  - name: Auth GCP
    command: gcloud auth activate-service-account --key-file=/tmp/gcp-sa.json
    changed_when: false

  - name: Get zones
    command: gcloud compute zones list --project {{ project_id }} --format="value(name)"
    register: zones
    changed_when: false

  - name: Build locations
    set_fact:
      locations: "{{ ['global'] + zones.stdout_lines }}"

  - name: Run recommenders
    command: >
      gcloud recommender recommendations list
      --project {{ project_id }}
      --location {{ item.0 }}
      --recommender {{ item.1 }}
      --format=json
    loop: "{{ locations | product(recommenders) | list }}"
    register: rec_calls
    changed_when: false
    failed_when: false

  - name: Aggregate recommendations (SAFE)
    set_fact:
      all_recommendations: >-
        {{
          all_recommendations | default([]) +
          (
            (item.stdout | default('[]') | from_json)
            | map('combine', {
                'recommender': item.item.1,
                'location': item.item.0,
                'category': recommender_category_map[item.item.1] | default('OTHER'),
                'description': (
                  item.content.overview.recommendationDescription
                  if item.content is defined
                     and item.content.overview is defined
                     and item.content.overview.recommendationDescription is defined
                  else 'Recommendation available (no summary text)'
                )
              })
            | list
          )
        }}
    loop: "{{ rec_calls.results }}"
    when:
      - item.stdout is defined
      - item.stdout | trim != "[]"

  - name: Build Teams message (Teams-safe)
    set_fact:
      teams_message: >-
        ğŸ“Š **GCP Recommender Report**\n
        Project : {{ project_id }}\n
        Time    : {{ lookup('pipe','date "+%Y-%m-%d %H:%M:%S"') }}\n
        \n
        ğŸ” **SUMMARY**\n
        â€¢ Total        : {{ all_recommendations | length }}\n
        â€¢ ğŸ’° Cost        : {{ all_recommendations | selectattr('category','equalto','COST') | list | length }}\n
        â€¢ ğŸš€ Performance : {{ all_recommendations | selectattr('category','equalto','PERFORMANCE') | list | length }}\n
        â€¢ ğŸ›¡ï¸ Security    : {{ all_recommendations | selectattr('category','equalto','SECURITY') | list | length }}\n
        â€¢ ğŸ§± Reliability : {{ all_recommendations | selectattr('category','equalto','RELIABILITY') | list | length }}\n
        \n
        ğŸ’° **TOP 5 COST**\n
        {% for r in (all_recommendations | selectattr('category','equalto','COST') | list)[:5] %}
        â€¢ ğŸ’¸ {{ r.location }} â†’ {{ r.description }}\n
        {% else %}
        â€¢ No cost recommendations\n
        {% endfor %}
        \n
        ğŸš€ **TOP 3 PERFORMANCE**\n
        {% for r in (all_recommendations | selectattr('category','equalto','PERFORMANCE') | list)[:3] %}
        â€¢ âš¡ {{ r.location }} â†’ {{ r.description }}\n
        {% else %}
        â€¢ No performance recommendations\n
        {% endfor %}

  - name: Send to Teams
    uri:
      url: "{{ teams_webhook_url }}"
      method: POST
      headers:
        Content-Type: application/json
      body_format: json
      body:
        text: "{{ teams_message }}"
      status_code: [200, 202]
